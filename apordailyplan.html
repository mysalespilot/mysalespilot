<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plan vs Achievement Entry</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body {
  font-family: 'Segoe UI', Tahoma, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 0;
}
.zone {
  margin: 20px auto;
  width: 95%;
  background: #fff;
  border: 1px solid #aaa;
  border-radius: 6px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  padding-bottom:10px;
}
.zone-header {
  background: #4e8b41;
  color: white;
  text-align: center;
  font-weight: bold;
  padding: 6px;
  font-size: 16px;
}
.sub-header {
  text-align: center;
  background: #d6ead2;
  color: #333;
  padding: 3px;
  font-weight: 600;
}
table {
  border-collapse: collapse;
  width: 100%;
  text-align: center;
  font-size: 12px;
}
th, td {
  border: 1px solid #888;
  padding: 4px;
}
th {
  background: #f2b9a1;
  font-weight: bold;
}
td[contenteditable="true"] {
  background: #fffbe6;
  cursor: text;
}
.total-row {
  background: #fff785;
  font-weight: bold;
}
.gtotal {
  background: #e0ffe0;
  font-weight: bold;
}
button {
  margin: 10px;
  padding: 8px 20px;
  background: #004aad;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}
button:hover { background: #003680; }
.action-buttons { text-align:center; }
</style>
</head>

<body id="page">

<!-- AP1 -->
<div class="zone">
  <div class="zone-header">AP1 VIZAG</div>
  <div class="sub-header">Plan VS Achievement</div>
  <table id="ap1">
    <thead>
      <tr><th rowspan="2">Mat3/Flavour</th><th colspan="2">BP</th><th colspan="2">CP</th><th rowspan="2">G Total</th></tr>
      <tr><th>Depot Plan</th><th>Factory Plan</th><th>Depot Plan</th><th>Factory Plan</th></tr>
    </thead>
    <tbody>
      <tr><td>SOYA</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td class="gtotal"></td></tr>
      <tr><td>GROUNDNUT</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td class="gtotal"></td></tr>
      <tr><td>KRUPA</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td class="gtotal"></td></tr>
      <tr><td>MUSTARD</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td class="gtotal"></td></tr>
      <tr><td>PALMOLEIN</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td class="gtotal"></td></tr>
      <tr><td>RICEBRAN</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td class="gtotal"></td></tr>
      <tr><td>SUNFLOWER</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td class="gtotal"></td></tr>
    </tbody>
    <tfoot>
      <tr class="total-row"><td>AP Total</td><td class="total"></td><td class="total"></td><td class="total"></td><td class="total"></td><td class="gtotal"></td></tr>
    </tfoot>
  </table>
</div>

<!-- AP2 -->
<div class="zone">
  <div class="zone-header">AP2 VIJAYAWADA</div>
  <div class="sub-header">Plan VS Achievement</div>
  <table id="ap2">
    <thead>
      <tr><th rowspan="2">Mat3/Flavour</th><th colspan="2">BP</th><th colspan="2">CP</th><th rowspan="2">G Total</th></tr>
      <tr><th>Depot Plan</th><th>Factory Plan</th><th>Depot Plan</th><th>Factory Plan</th></tr>
    </thead>
    <tbody>
      <tr><td>SOYA</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td class="gtotal"></td></tr>
      <tr><td>GROUNDNUT</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td class="gtotal"></td></tr>
      <tr><td>KRUPA</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td class="gtotal"></td></tr>
      <tr><td>MUSTARD</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td class="gtotal"></td></tr>
      <tr><td>PALMOLEIN</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td class="gtotal"></td></tr>
      <tr><td>RICEBRAN</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td class="gtotal"></td></tr>
      <tr><td>SUNFLOWER</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td class="gtotal"></td></tr>
    </tbody>
    <tfoot>
      <tr class="total-row"><td>AP Total</td><td class="total"></td><td class="total"></td><td class="total"></td><td class="total"></td><td class="gtotal"></td></tr>
    </tfoot>
  </table>
</div>

<!-- ORISSA -->
<div class="zone">
  <div class="zone-header">ORISSA</div>
  <div class="sub-header">Plan Entry</div>
  <table id="orissa">
    <thead>
      <tr><th rowspan="2">Mat3/Flavour</th><th colspan="2">BP</th><th colspan="2">CP</th><th rowspan="2">G Total</th></tr>
      <tr><th>Depot Plan</th><th>Factory Plan</th><th>Depot Plan</th><th>Factory Plan</th></tr>
    </thead>
    <tbody>
      <tr><td>SOYA</td><td contenteditable>0</td><td contenteditable>0</td><td contenteditable>0.5</td><td contenteditable>0</td><td class="gtotal">0.5</td></tr>
      <tr><td>GROUNDNUT</td><td contenteditable>0</td><td contenteditable>0</td><td contenteditable>0.2</td><td contenteditable>0</td><td class="gtotal">0.2</td></tr>
      <tr><td>KRUPA</td><td contenteditable>0</td><td contenteditable>0</td><td contenteditable>0.3</td><td contenteditable>0</td><td class="gtotal">0.3</td></tr>
      <tr><td>MUSTARD</td><td contenteditable>0</td><td contenteditable>0</td><td contenteditable>24</td><td contenteditable>0</td><td class="gtotal">24</td></tr>
      <tr><td>PALMOLEIN</td><td contenteditable>2</td><td contenteditable>0</td><td contenteditable>3</td><td contenteditable>10</td><td class="gtotal">15</td></tr>
      <tr><td>RICEBRAN</td><td contenteditable>0</td><td contenteditable>0</td><td contenteditable>0.5</td><td contenteditable>0</td><td class="gtotal">0.5</td></tr>
      <tr><td>SUNFLOWER</td><td contenteditable>0</td><td contenteditable>0</td><td contenteditable>148</td><td contenteditable>42</td><td class="gtotal">190</td></tr>
    </tbody>
    <tfoot>
      <tr class="total-row"><td>OR Total</td><td class="total">2</td><td class="total">0</td><td class="total">176.5</td><td class="total">52</td><td class="gtotal">230.5</td></tr>
    </tfoot>
  </table>
</div>

<div class="action-buttons">
  <button onclick="submitToSheet()">Submit to Google Sheet</button>
  <button onclick="downloadExcel()">Download Excel</button>
  <button onclick="downloadFullJPG()">Download JPG</button>
</div>

<script>
function calculateTotals() {
  document.querySelectorAll('.zone table').forEach(table => {
    const rows = table.querySelectorAll('tbody tr');
    let columnTotals = Array(4).fill(0);
    rows.forEach(row => {
      const cells = row.querySelectorAll('td[contenteditable]');
      let rowSum = 0;
      cells.forEach((cell, i) => {
        const val = parseFloat(cell.innerText) || 0;
        rowSum += val;
        columnTotals[i] += val;
      });
      row.querySelector('.gtotal').innerText = rowSum.toFixed(2);
    });

    table.querySelectorAll('tfoot .total').forEach((cell, i) =>
      cell.innerText = columnTotals[i].toFixed(2)
    );

    table.querySelector('tfoot .gtotal').innerText =
      columnTotals.reduce((a,b)=>a+b,0).toFixed(2);
  });
}
document.addEventListener('input', e => {
  if(e.target.hasAttribute('contenteditable')) calculateTotals();
});

// ✅ Google Sheet Submit
async function submitToSheet() {
  const payload = [];
  document.querySelectorAll('.zone').forEach(zone => {
    const zoneName = zone.querySelector('.zone-header').innerText;
    zone.querySelectorAll('tbody tr').forEach(row => {
      const m = row.querySelector('td:first-child').innerText;
      const c = row.querySelectorAll('td[contenteditable]');
      payload.push({
        zone: zoneName,
        material: m,
        bp_depot: parseFloat(c[0].innerText)||0,
        bp_factory: parseFloat(c[1].innerText)||0,
        cp_depot: parseFloat(c[2].innerText)||0,
        cp_factory: parseFloat(c[3].innerText)||0,
        total: ((parseFloat(c[0].innerText)||0)+(parseFloat(c[1].innerText)||0)+(parseFloat(c[2].innerText)||0)+(parseFloat(c[3].innerText)||0)).toFixed(2)
      });
    });
  });

  await fetch("https://script.google.com/macros/s/AKfycbxzAJJuoQP_oG99RtsiHM9XD-VoiJw9RiloBRZX_NNJFQinC4L4ora6vJ_C9x26o2y7NQ/exec", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  alert("✅ Data sent to Google Sheet");
}

// ✅ Excel Download
async function downloadExcel(){
  const wb = await XlsxPopulate.fromBlankAsync();
  const sheet = wb.sheet(0);
  let row = 1;

  document.querySelectorAll('.zone').forEach(zone => {
    sheet.cell(row,1).value(zone.querySelector('.zone-header').innerText).style({bold:true,fill:"4e8b41",fontColor:"ffffff"});
    row+=2;
    zone.querySelectorAll('tr').forEach(tr=>{
      let col=1;
      tr.querySelectorAll('th,td').forEach(c=>{
        sheet.cell(row,col++).value(c.innerText||"").style({border:true, horizontalAlignment:"center"});
      });
      row++;
    });
    row+=1;
  });

  const blob = await wb.outputAsync();
  const link = document.createElement('a');
  link.href = URL.createObjectURL(new Blob([blob], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}));
  link.download = "PlanVsAchievement_ORISSA.xlsx";
  link.click();
}

// ✅ FULL PAGE JPG
function downloadFullJPG() {
  const page = document.getElementById("page");
  html2canvas(page, { scale: 2 }).then(canvas => {
    const link = document.createElement("a");
    link.download = "PlanVsAchievement.jpg";
    link.href = canvas.toDataURL("image/jpeg", 1.0);
    link.click();
  });
}
</script>
</body>
</html>
